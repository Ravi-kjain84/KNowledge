import os
import shutil
import re
from openpyxl import load_workbook

# Define the original and temporary folder paths
original_folder = 'path/to/original/folder'
temp_folder = 'path/to/temporary/folder'

# Define the list of keywords to search within formulas
search_keywords = ["getValue", "retrieveData", "calculateTotal"]

# Compile regex patterns for each keyword to find matches in formulas
patterns = {keyword: re.compile(rf"\b{re.escape(keyword)}\b", re.IGNORECASE) for keyword in search_keywords}

# Create a temporary folder to store non-password-protected copies
if not os.path.exists(temp_folder):
    os.makedirs(temp_folder)
    print(f"Created temporary folder at '{temp_folder}'")
else:
    print(f"Temporary folder '{temp_folder}' already exists")

# Copy all files to the temporary folder, keeping the folder structure
print("Starting file copy process...")
for root, _, files in os.walk(original_folder):
    for file_name in files:
        # Check if the file is an Excel file
        if file_name.endswith('.xlsx') or file_name.endswith('.xlsm'):
            # Construct full file paths
            src = os.path.join(root, file_name)
            
            # Preserve folder structure in the temporary folder
            relative_path = os.path.relpath(root, original_folder)
            dest_dir = os.path.join(temp_folder, relative_path)
            if not os.path.exists(dest_dir):
                os.makedirs(dest_dir)
                print(f"Created directory '{dest_dir}' in temporary folder")

            dest = os.path.join(dest_dir, file_name)
            
            # Copy the file to the corresponding location in the temporary folder
            shutil.copy(src, dest)
            print(f"Copied '{file_name}' to temporary folder")

print("File copy process completed. Starting search for keywords...")

# Dictionary to store files containing any of the keywords, with the matched keyword(s)
files_with_keywords = {}

# Now iterate through the copied files in the temporary folder
for root, _, files in os.walk(temp_folder):
    for file_name in files:
        file_path = os.path.join(root, file_name)
        print(f"Checking file '{file_name}' for keywords {search_keywords}...")

        # Try opening the workbook, skipping if it's password-protected
        try:
            workbook = load_workbook(file_path, data_only=False)  # Load formulas as they are
            print(f"Opened workbook '{file_name}' successfully")
        except Exception as e:
            print(f"Could not open '{file_name}' due to password protection or other error.")
            continue

        # Search for each keyword in formulas in each sheet
        found_keywords = set()
        for sheet in workbook.sheetnames:
            print(f"Searching in sheet '{sheet}' of '{file_name}'...")
            worksheet = workbook[sheet]
            for row in worksheet.iter_rows():
                for cell in row:
                    if cell.data_type == 'f':  # Only check cells with formulas
                        cell_value = str(cell.value)
                        # Check each pattern to see if any keyword matches
                        for keyword, pattern in patterns.items():
                            if pattern.search(cell_value):
                                found_keywords.add(keyword)
                                print(f"Keyword '{keyword}' found in '{file_name}' in sheet '{sheet}'")
                                break  # Stop checking other keywords for this cell
                if found_keywords:
                    break  # Stop further search in this sheet if a keyword is found
            if found_keywords:
                break  # Stop further search in this file if a keyword is found
        workbook.close()

        # If any keywords were found, update the results dictionary
        if found_keywords:
            files_with_keywords[file_name] = list(found_keywords)
            print(f"File '{file_name}' updated in the results list with matched keywords: {found_keywords}")

print("Search completed.")

# Output the results
if files_with_keywords:
    print("\nThe following files contain formulas with the specified keywords:")
    for file, keywords in files_with_keywords.items():
        print(f"File: {file} - Matched Keywords: {', '.join(keywords)}")
else:
    print("No files containing the specified keywords were found.")